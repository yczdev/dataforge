<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DataForge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'ui-sans-serif', 'system-ui'] } } } };
  </script>
</head>
<body class="h-full bg-zinc-950 text-zinc-100 font-sans">
  <form style="display:none">{% csrf_token %}</form>
  <header class="border-b border-zinc-800">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-semibold">DataForge</h1>
      <div>
        <button id="openModalBtn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md text-sm font-medium mr-4">Create New Schema</button>
        <button id="logoutBtn" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-md text-sm font-medium">Logout</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <div id="schemasContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    <div id="emptyState" class="text-center py-16 hidden">
      <h2 class="text-xl font-semibold text-zinc-400">No schemas created yet.</h2>
      <p class="text-zinc-500 mt-2">Click "Create New Schema" to get started.</p>
    </div>
  </main>

  <div id="schemaModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden">
    <div class="bg-zinc-900 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between p-4 border-b border-zinc-800">
        <h3 class="text-lg font-semibold">Create New Schema</h3>
        <button id="closeModalBtn" class="text-zinc-400 hover:text-white">&times;</button>
      </div>
      <form id="schemaForm" class="flex-grow overflow-y-auto p-6 space-y-6">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="sm:col-span-2">
            <label for="schemaName" class="block text-sm font-medium text-zinc-300 mb-1">Schema Name</label>
            <input type="text" id="schemaName" required class="w-full bg-zinc-800 border-zinc-700 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
          <div>
            <label for="rowCount" class="block text-sm font-medium text-zinc-300 mb-1">Number of Rows</label>
            <input type="number" id="rowCount" value="25" min="1" max="10000" required class="w-full bg-zinc-800 border-zinc-700 rounded-md p-2 focus:ring-indigo-500 focus:border-indigo-500">
          </div>
        </div>
        <div>
          <h4 class="text-sm font-medium text-zinc-300 mb-2">Fields</h4>
          <div id="fieldsContainer" class="space-y-3"></div>
          <button type="button" id="addFieldBtn" class="mt-3 text-indigo-400 hover:text-indigo-300 text-sm font-medium">+ Add Field</button>
        </div>
      </form>
      <div class="flex items-center justify-end p-4 border-t border-zinc-800">
        <button id="cancelBtn" class="text-zinc-300 hover:bg-zinc-700 px-4 py-2 rounded-md text-sm mr-2">Cancel</button>
        <button type="submit" form="schemaForm" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-md text-sm font-medium">Save Schema</button>
      </div>
    </div>
  </div>

  <template id="fieldRowTemplate">
    <div class="flex items-center gap-2">
      <input type="text" placeholder="Field Name" class="flex-grow bg-zinc-800 border-zinc-700 rounded-md p-2 text-sm">
      <select class="bg-zinc-800 border-zinc-700 rounded-md p-2 text-sm">
        <option value="full_name">Full Name</option><option value="first_name">First Name</option><option value="last_name">Last Name</option><option value="email">Email</option><option value="city">City</option><option value="country">Country</option><option value="address">Address</option><option value="phone">Phone Number</option><option value="company">Company</option><option value="job">Job Title</option><option value="uuid">UUID</option><option value="date">Date</option><option value="datetime">Datetime</option><option value="integer">Integer</option><option value="float">Float</option><option value="boolean">Boolean</option>
      </select>
      <button type="button" class="text-zinc-400 hover:text-red-400 p-1">&times;</button>
    </div>
  </template>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        const apiBase = '/api';
        let currentSchemaId = null;

        const schemasContainer = document.getElementById('schemasContainer');
        const emptyState = document.getElementById('emptyState');
        const modal = document.getElementById('schemaModal');
        const openModalBtn = document.getElementById('openModalBtn');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const schemaForm = document.getElementById('schemaForm');
        const fieldsContainer = document.getElementById('fieldsContainer');
        const addFieldBtn = document.getElementById('addFieldBtn');
        const fieldRowTemplate = document.getElementById('fieldRowTemplate');
        const logoutBtn = document.getElementById('logoutBtn');

        const token = localStorage.getItem('authToken');
        if (!token) {
            window.location.href = '/login/';
        }

        const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const getAuthHeaders = () => ({
            'Content-Type': 'application/json',
            'Authorization': `Token ${token}`,
            'X-CSRFToken': getCsrfToken()
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = '/login/';
        });
        
        const toggleEmpty = () => emptyState.classList.toggle('hidden', schemasContainer.children.length > 0);

        const openModal = () => {
            schemaForm.reset();
            document.getElementById('rowCount').value = 25;
            fieldsContainer.innerHTML = '';
            modal.classList.remove('hidden');
        };

        const closeModal = () => {
            modal.classList.add('hidden');
            currentSchemaId = null;
        };

        function addFieldRow(name = '', type = 'full_name') {
            const node = fieldRowTemplate.content.cloneNode(true);
            const row = node.querySelector('div');
            row.querySelector('input').value = name;
            row.querySelector('select').value = type;
            row.querySelector('button').addEventListener('click', () => row.remove());
            fieldsContainer.appendChild(row);
        }

        function renderSchemaCard(schema) {
            const card = document.createElement('div');
            card.className = 'bg-zinc-900 border border-zinc-800 rounded-lg p-4 flex flex-col gap-4';
            card.setAttribute('data-schema-id', schema.id);

            const fieldsHtml = schema.definition.map(f => `<span class="bg-zinc-700 text-zinc-300 text-xs px-2 py-1 rounded">${f.field_name}</span>`).join('');
            
            card.innerHTML = `
            <div>
                <div class="flex justify-between items-start">
                <h3 class="font-semibold text-lg">${schema.name}</h3>
                <div class="flex items-center gap-2">
                    <button data-id="${schema.id}" class="updateBtn bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded-md text-xs font-semibold">Update</button>
                    <button data-id="${schema.id}" class="deleteBtn bg-red-600 hover:bg-red-500 text-white px-3 py-1 rounded-md text-xs font-semibold">Delete</button>
                </div>
                </div>
                <p class="text-xs text-zinc-500 mt-1">Rows to generate: ${schema.row_count}</p>
            </div>
            <div class="flex-grow">
                <p class="text-sm text-zinc-400 mb-2">Fields:</p>
                <div class="flex flex-wrap gap-2">${fieldsHtml || '<span class="text-zinc-500 text-sm">No fields defined.</span>'}</div>
            </div>
            <div class="border-t border-zinc-800 pt-3 flex flex-wrap gap-2 items-center justify-end">
                <span class="font-semibold text-sm mr-2">Download:</span>
                <button data-name="${schema.name}" data-id="${schema.id}" data-format="csv" class="downloadBtn px-3 py-2 rounded-md bg-indigo-600 hover:bg-indigo-500 text-sm">CSV</button>
                <button data-name="${schema.name}" data-id="${schema.id}" data-format="json" class="downloadBtn px-3 py-2 rounded-md bg-teal-600 hover:bg-teal-500 text-sm">JSON</button>
            </div>
            `;

            card.querySelector('.deleteBtn').addEventListener('click', async (e) => {
                if (!confirm('Are you sure you want to delete this schema?')) return;
                const id = e.currentTarget.getAttribute('data-id');
                await fetch(`${apiBase}/schemas/${id}/`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                card.remove();
                toggleEmpty();
            });
            
            card.querySelector('.updateBtn').addEventListener('click', () => {
                currentSchemaId = schema.id;
                openModal();
                modal.querySelector('h3').textContent = 'Update Schema';
                document.getElementById('schemaName').value = schema.name;
                document.getElementById('rowCount').value = schema.row_count;
                schema.definition.forEach(field => addFieldRow(field.field_name, field.data_type));
            });

            card.querySelectorAll('.downloadBtn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const button = e.currentTarget;
                    const id = button.getAttribute('data-id');
                    const format = button.getAttribute('data-format');
                    const name = button.getAttribute('data-name');
                    const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();

                    const originalText = button.textContent;
                    button.textContent = 'Downloading...';
                    button.disabled = true;

                    try {
                        const resp = await fetch(`${apiBase}/schemas/${id}/download/?format=${format}`);
                        if (resp.ok) {
                            const blob = await resp.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `${safeName}.${format}`;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        } else {
                            alert(`Failed to download ${format.toUpperCase()} file.`);
                        }
                    } catch (error) {
                        console.error('Download error:', error);
                        alert('An error occurred during download.');
                    } finally {
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                });
            });

            return card;
        }

        async function fetchSchemas() {
            const resp = await fetch(`${apiBase}/schemas/`, { headers: getAuthHeaders() });
            if (resp.status === 401 || resp.status === 403) {
                localStorage.removeItem('authToken');
                window.location.href = '/login/';
                return;
            }
            const schemas = await resp.json();
            schemasContainer.innerHTML = '';
            schemas.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
            schemas.forEach(schema => {
                const card = renderSchemaCard(schema);
                schemasContainer.appendChild(card);
            });
            toggleEmpty();
        }

        openModalBtn.addEventListener('click', () => {
            currentSchemaId = null;
            openModal();
            modal.querySelector('h3').textContent = 'Create New Schema';
            addFieldRow();
        });

        closeModalBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeModal(); });
        addFieldBtn.addEventListener('click', () => addFieldRow());

        schemaForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('schemaName').value.trim();
            const row_count = parseInt(document.getElementById('rowCount').value, 10);
            const definition = Array.from(fieldsContainer.children).map(row => {
                const [nameInput, typeSelect] = row.querySelectorAll('input,select');
                return { field_name: nameInput.value.trim(), data_type: typeSelect.value };
            }).filter(d => d.field_name);
            
            if (!name || isNaN(row_count) || row_count < 1) {
              alert('Please fill in all fields correctly.');
              return;
            }
            
            const payload = { name, row_count, definition };
            const isUpdating = currentSchemaId !== null;
            const url = isUpdating ? `${apiBase}/schemas/${currentSchemaId}/` : `${apiBase}/schemas/`;
            const method = isUpdating ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers: getAuthHeaders(),
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                alert(`Failed to save schema: ` + (errData.detail || JSON.stringify(errData)));
                return;
            }

            await fetchSchemas();
            closeModal();
        });

        fetchSchemas();
    });
  </script>
</body>
</html>